# 全銀協フォーマット対応データ作成システム ユーザーマニュアル

## 目次
1. [システム概要](#1-システム概要)
2. [事前準備](#2-事前準備)
3. [基本操作](#3-基本操作)
4. [データ入力](#4-データ入力)
5. [CSV取込処理](#5-csv取込処理)
6. [ファイル生成](#6-ファイル生成)
7. [エラー対処](#7-エラー対処)
8. [FAQ・トラブルシューティング](#8-faqトラブルシューティング)

---

## 1. システム概要

### 1.1 システムの目的
本システムは、全銀協フォーマットに準拠した振込データファイルを簡単に作成するためのツールです。Googleスプレッドシートを利用して、振込データの入力から全銀協フォーマットファイルの生成まで一貫して行えます。

### 1.2 主な機能
- **振込データ入力**: スプレッドシート上で直接データ入力
- **CSV取込**: 既存のCSVファイルからデータを一括取込
- **自動補完**: 銀行コード・支店コードから銀行名・支店名を自動設定
- **データ検証**: 入力データの妥当性を自動チェック
- **ファイル生成**: 全銀協フォーマット準拠のファイルを自動生成
- **ログ管理**: 処理履歴の記録と確認

### 1.3 動作環境
- **Googleアカウント**: 必須
- **Googleスプレッドシート**: 最新版推奨
- **ブラウザ**: Chrome、Firefox、Safari、Edge（最新版推奨）

---

## 2. 事前準備

### 2.1 スプレッドシートの準備
1. Googleスプレッドシートを開きます
2. 新しいスプレッドシートを作成します

### 2.2 GASソースコードの登録
システムを動作させるため、Google Apps Script（GAS）のソースコードを登録する必要があります。

#### 2.2.1 Apps Scriptエディタを開く
1. スプレッドシートのメニューから「拡張機能」→「Apps Script」をクリック
2. Apps Scriptエディタが新しいタブで開きます
3. 初期状態で「コード.gs」ファイルが作成されています

#### 2.2.2 ソースファイルの作成
以下の手順で必要なファイルを作成してください：

1. **既存ファイルの削除**
   - 「コード.gs」ファイルを削除します
   - ファイル名横の「⋮」メニューから「削除」を選択

2. **必要ファイルの作成**
   以下のファイルを順番に作成します：
   
   - **appsscript.json** (マニフェストファイル)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「appsscript.json」に変更
     - 提供されたappsscript.jsonの内容をコピー＆ペースト
   
   - **Constants.gs** (定数定義)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「Constants.gs」に変更
     - 提供されたConstants.gsの内容をコピー＆ペースト
   
   - **Menu.gs** (メニュー機能)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「Menu.gs」に変更
     - 提供されたMenu.gsの内容をコピー＆ペースト
   
   - **SheetSetup.gs** (シート設定)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「SheetSetup.gs」に変更
     - 提供されたSheetSetup.gsの内容をコピー＆ペースト
   
   - **Validation.gs** (データ検証)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「Validation.gs」に変更
     - 提供されたValidation.gsの内容をコピー＆ペースト
   
   - **CsvProcessor.gs** (CSV処理)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「CsvProcessor.gs」に変更
     - 提供されたCsvProcessor.gsの内容をコピー＆ペースト
   
   - **AutoComplete.gs** (自動補完)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「AutoComplete.gs」に変更
     - 提供されたAutoComplete.gsの内容をコピー＆ペースト
   
   - **ZenginFormat.gs** (全銀協フォーマット)
     - 「+」ボタン → 「ファイル」をクリック
     - ファイル名を「ZenginFormat.gs」に変更
     - 提供されたZenginFormat.gsの内容をコピー＆ペースト

#### 2.2.3 ソースコードの保存と実行
1. **保存**
   - Ctrl+S（Windows）またはCmd+S（Mac）で保存
   - または「保存」ボタンをクリック

2. **権限の承認**
   - 初回実行時に権限の承認が必要です
   - 「実行」ボタンをクリック
   - 権限確認ダイアログで「権限を確認」をクリック
   - Googleアカウントを選択し、「許可」をクリック

3. **動作確認**
   - スプレッドシートに戻り、ページを再読み込み
   - メニューバーに「全銀協システム」が表示されることを確認

#### 2.2.4 注意事項
- **ファイル名の正確性**: ファイル名は大文字・小文字を含めて正確に入力してください
- **コピー＆ペースト**: ソースコードは提供されたファイルから完全にコピーしてください
- **保存の確認**: 各ファイル作成後は必ず保存を確認してください
- **エラー対処**: エラーが発生した場合は、ソースコードの内容を再確認してください

### 2.3 カスタムメニューの確認
GASソースコードの登録後、スプレッドシートを開くとメニューバーに「全銀協システム」が自動的に追加されます。
もし表示されない場合は、以下を試してください：
1. ページを再読み込み
2. Apps Scriptエディタでソースコードが正しく保存されているか確認
3. エラーログを確認（Apps Scriptエディタの「実行」→「ログを表示」）

### 2.4 シート構成の初期化
GASソースコードの登録とメニューの確認が完了したら、必要なシートを自動作成します：

1. **シート構成の初期化を実行**
   - 「全銀協システム」→「システム設定」→「シート構成の初期化」をクリック
   - 以下の3つのシートが自動的に作成されます：
     - `振込依頼人情報` - 振込依頼人の基本情報入力シート
     - `振込データ` - 個別の振込データ入力シート
     - `金融機関マスタ` - 銀行・支店コードと名称の管理シート

2. **初期化完了の確認**
   - 「シート設定完了」メッセージが表示されることを確認
   - 各シートが正しく作成され、ヘッダーや入力検証が設定されていることを確認

#### 2.4.1 作成されるシートの詳細
- **振込依頼人情報シート**: 委託者コード、委託者名等の基本情報入力欄とプルダウンメニューが設定済み
- **振込データシート**: 振込先情報入力用のヘッダー行と列幅調整、入力検証ルールが設定済み
- **金融機関マスタシート**: 銀行・支店コードと名称の管理用テーブル構造が設定済み

### 2.5 その他の初期設定
必要に応じて「全銀協システム」→「システム設定」から追加の設定を行います。

---

## 3. 基本操作

### 3.1 メニュー構成
```
全銀協システム
├── 振込用CSV取込処理
├── 振込データ作成処理
├── ─────────────────
├── データ検証
├── 金融機関マスタ管理
│   ├── 金融機関データ一括取込
│   ├── 銀行・支店名自動補完
│   └── マスタデータ整備
└── システム設定
    ├── ログ表示
    ├── ログフィルタ表示
    └── システム設定
```

### 3.2 基本的な作業フロー
1. **振込依頼人情報の入力**
2. **振込データの入力**（直接入力またはCSV取込）
3. **データ検証**
4. **全銀協ファイルの生成**

---

## 4. データ入力

### 4.1 振込依頼人情報の入力

#### 4.1.1 入力項目
「振込依頼人情報」シートの以下の項目を入力してください：

| 項目名 | 入力場所 | 必須 | 説明・制約 |
|--------|----------|------|-----------|
| 委託者コード | B2 | ○ | 10桁の数字（銀行から指示されたコード） |
| 委託者名 | B3 | ○ | 40文字以内の半角カナ |
| 取引銀行コード | B4 | ○ | 4桁の銀行コード |
| 取引銀行名 | B5 | ○ | 15文字以内の半角カナ |
| 取引支店コード | B6 | ○ | 3桁の支店コード |
| 取引支店名 | B7 | ○ | 15文字以内の半角カナ |
| 預金種目 | B8 | ○ | 1:普通、2:当座 |
| 口座番号 | B9 | ○ | 7桁以内の数字 |
| 種別コード | B10 | ○ | 11:給与、12:賞与 |
| 出力ファイル拡張子 | B11 | ○ | .dat、.txt、.fb から選択 |
| 銀行名・支店名出力モード | B12 | ○ | 標準（スペース埋め）、名称出力 から選択 |

#### 4.1.2 注意事項
- **委託者コード**: 取引銀行から指定された10桁のコードを正確に入力
- **委託者名**: 全角20文字以内（半角カナ40文字以内）
- **種別コード**: 給与振込の場合は「11」、賞与振込の場合は「12」
- **銀行名・支店名出力モード**: 
  - 標準：銀行名・支店名をスペースで埋める（一般的）
  - 名称出力：実際の銀行名・支店名を出力

### 4.2 振込データの入力

#### 4.2.1 入力項目
「振込データ」シートの各列に以下の情報を入力してください：

| 列 | 項目名 | 必須 | 説明・制約 |
|----|--------|------|-----------|
| A | 銀行コード | ○ | 4桁の数字 |
| B | 銀行名 | △ | 15文字以内の半角カナ（自動補完可） |
| C | 支店コード | ○ | 3桁の数字 |
| D | 支店名 | △ | 15文字以内の半角カナ（自動補完可） |
| E | 預金種目 | ○ | 1:普通、2:当座 |
| F | 口座番号 | ○ | 7桁以内の数字 |
| G | 受取人名 | ○ | 30文字以内の半角カナ・英数字 |
| H | 振込金額 | ○ | 1円以上99億円以下の数字 |
| I | 顧客コード | △ | 10文字以内の英数字 |
| J | 識別表示 | △ | Y:給与、B:賞与 |
| K | EDI情報 | △ | 20文字以内の任意情報 |

#### 4.2.2 入力のコツ
- **銀行名・支店名**: 銀行コード・支店コードを入力後、自動補完機能で設定可能
- **受取人名**: 姓名間のスペースは不要（全銀協推奨）
- **振込金額**: カンマ（,）は入力しない
- **顧客コード**: 社員番号等の管理用ID

---

## 5. CSV取込処理

### 5.1 対応CSVフォーマット

#### 5.1.1 基本仕様
- **ファイル形式**: CSV（拡張子：.csv）
- **文字コード**: UTF-8またはShift_JIS
- **ファイルサイズ**: 10MB以下
- **最大件数**: 1,000件まで

#### 5.1.2 CSVファイルの構成
```csv
銀行コード,支店コード,預金種目,口座番号,受取人名,振込金額,顧客コード,識別表示
0001,001,1,1234567,ﾔﾏﾀﾞﾊﾅｺ,100000,EMP001,Y
0001,002,1,2345678,ﾀﾅｶﾀﾛｳ,200000,EMP002,Y
```

### 5.2 取込手順
1. **メニューから実行**
   - 「全銀協システム」→「振込用CSV取込処理」をクリック

2. **ファイル選択**
   - 「CSVファイルを選択」ボタンをクリック
   - 対象のCSVファイルを選択

3. **取込モード選択**
   - **既存データを上書き**: 既存データを削除して新規取込
   - **既存データに追記**: 既存データの下に追加

4. **取込実行**
   - 「取込実行」ボタンをクリック
   - 処理完了メッセージを確認

### 5.3 取込後の処理
- 自動的に銀行名・支店名の補完が実行されます
- エラーがある場合は詳細メッセージが表示されます

---

## 6. ファイル生成

### 6.1 生成前の確認
1. **振込依頼人情報**が正しく入力されているか確認
2. **振込データ**が正しく入力されているか確認
3. **データ検証**を実行してエラーがないか確認

### 6.2 ファイル生成手順
1. **データ検証の実行**
   - 「全銀協システム」→「データ検証」をクリック
   - エラーがある場合は修正してから次の手順へ

2. **ファイル生成の実行**
   - 「全銀協システム」→「振込データ作成処理」をクリック
   - 処理完了メッセージを確認

3. **ファイルのダウンロード**
   - 生成されたファイルを「ダウンロード」からダンロード
   - ファイル名は「委託者コード_YYMMDD_HHMM.拡張子」の形式

### 6.3 生成されるファイル
- **ファイル形式**: 120バイト固定長、改行なし
- **文字コード**: JIS（全銀協標準）
- **レコード構成**: ヘッダ → データ → トレーラ → エンド

---

## 7. エラー対処

### 7.1 よくあるエラーと対処法

#### 7.1.1 データ入力エラー
**エラー**: 「必須項目が入力されていません」
- **原因**: 必須項目が空白
- **対処**: 該当項目を確認して正しく入力

**エラー**: 「使用できない文字が含まれています」
- **原因**: 全角文字やカンマ等の使用禁止文字
- **対処**: 半角カナ・英数字のみ使用

**エラー**: 「文字数制限を超えています」
- **原因**: 項目の文字数制限超過
- **対処**: 制限文字数以内に調整

#### 7.1.2 CSV取込エラー
**エラー**: 「ヘッダー行の項目名が一致しません」
- **原因**: CSVヘッダーの項目名が規定と異なる
- **対処**: 正確なヘッダー名を使用

**エラー**: 「ファイルサイズが制限を超えています」
- **原因**: CSVファイルが10MBを超過
- **対処**: ファイルサイズを削減またはデータを分割

#### 7.1.3 ファイル生成エラー
**エラー**: 「金融機関コードが見つかりません」
- **原因**: 金融機関マスタに存在しないコード
- **対処**: 正しい銀行コード・支店コードを確認

### 7.2 エラーログの確認
- 「全銀協システム」→「システム設定」→「ログ表示」
- エラーの詳細情報と発生時刻を確認可能

---

## 8. FAQ・トラブルシューティング

### 8.1 よくある質問

**Q1. 銀行名・支店名の自動補完が動作しない**
- A1. 金融機関マスタデータが不足している可能性があります。「金融機関データ一括取込」を実行してください。

**Q2. 受取人名に使用できる文字は？**
- A2. 半角カナ、英数字、記号（カンマ除く）が使用可能です。全角文字は使用できません。

**Q3. 振込金額の上限は？**
- A3. 1円以上99億円以下です。カンマ区切りの入力はできません。

**Q4. ファイル生成後のファイル名の意味は？**
- A4. 「委託者コード_YYMMDD_HHMM.拡張子」の形式です。日時は生成時刻を表します。

**Q5. 複数の振込種別（給与・賞与）を同時に処理できますか？**
- A5. いいえ、1つのファイルには1つの種別のみ含めることができます。種別ごとに分けて処理してください。

### 8.2 トラブルシューティング

#### 8.2.1 メニューが表示されない場合
1. ブラウザを再読み込み
2. Googleアカウントでログインしているか確認
3. スプレッドシートの編集権限があるか確認

#### 8.2.2 処理が途中で止まる場合
1. 「システム設定」→「ログ表示」でエラーログを確認
2. データ量が多い場合は件数を減らして再実行
3. ブラウザのキャッシュをクリア

#### 8.2.3 生成されたファイルが正しく開けない場合
1. ファイルの文字コードがJISになっているか確認
2. ファイルサイズが想定通りか確認（120バイト×レコード数）
3. バイナリエディタで内容を確認

### 8.3 サポート情報
- **システムログ**: 「全銀協システム」→「システム設定」→「ログ表示」
- **フィルタログ**: 「全銀協システム」→「システム設定」→「ログフィルタ表示」
- **エラー分類**: INFO（情報）、WARNING（警告）、ERROR（エラー）

---

## 9. 補足情報

### 9.1 全銀協フォーマットについて
- 全国銀行協会が定めた振込データの標準フォーマット
- 金融機関間でのデータ交換に使用
- 120バイト固定長、JIS文字コード使用

### 9.2 システムの制限事項
- 最大処理件数: 1,000件/ファイル
- 最大ファイルサイズ: 10MB（CSV取込時）
- 対応文字: 半角カナ・英数字・記号（カンマ除く）

### 9.3 推奨環境
- Google Chrome（最新版）
- 安定したインターネット接続
- 十分なGoogleドライブ容量

---