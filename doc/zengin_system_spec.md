# 全銀協フォーマット対応データ作成システム仕様書

## システム概要

Google Apps Script（GAS）とGoogleスプレッドシートを利用して、全銀協フォーマットに準拠した振込データファイルを作成するシステムです。

## システム構成

### 1. スプレッドシートワークブック構成

#### 1.1 振込依頼人情報登録シート
**シート名**: `振込依頼人情報`

| 項目名 | セル位置 | データ型 | 必須 | 説明 |
|--------|----------|----------|------|------|
| 委託者コード | B2 | 文字列(10桁) | ○ | 振込依頼人識別コード |
| 委託者名 | B3 | 半角カナ(40文字) | ○ | 振込依頼人名（全角20文字相当） |
| 取引銀行コード | B4 | 数字(4桁) | ○ | 振込依頼人取引銀行コード |
| 取引銀行名 | B5 | 半角カナ(15文字) | ○ | 振込依頼人取引銀行名 |
| 取引支店コード | B6 | 数字(3桁) | ○ | 振込依頼人取引支店コード |
| 取引支店名 | B7 | 半角カナ(15文字) | ○ | 振込依頼人取引支店名 |
| 預金種目 | B8 | 数字(1桁) | ○ | 1:普通, 2:当座, 4:貯蓄 |
| 口座番号 | B9 | 数字(7桁) | ○ | 振込依頼人口座番号 |
| 種別コード | B10 | 数字(2桁) | ○ | 11:給与, 12:賞与, その他は要確認 | 全銀協準拠コード |
| 出力ファイル拡張子 | B11 | 選択肢 | ○ | .dat / .txt / .fb のいずれかを選択 |
| 銀行名・支店名出力モード | B12 | 選択肢 | ○ | 標準（スペース埋め） / 名称出力 のいずれかを選択 |

#### 1.2 振込用データ入力シート
**シート名**: `振込データ`

| 列 | 項目名 | データ型 | 必須 | 説明 |
|----|--------|----------|------|------|
| A | 銀行コード | 数字(4桁) | ○ | 振込先銀行コード |
| B | 銀行名 | 半角カナ(15文字) | △ | 自動補完可能 |
| C | 支店コード | 数字(3桁) | ○ | 振込先支店コード |
| D | 支店名 | 半角カナ(15文字) | △ | 自動補完可能 |
| E | 預金種目 | 数字(1桁) | ○ | 1:普通, 2:当座（4:貯蓄は全銀協対象外） |
| F | 口座番号 | 数字(7桁) | ○ | 振込先口座番号 |
| G | 受取人名 | 英数カナ(30文字) | ○ | 受取人名（全銀協フォーマット準拠） |
| H | 振込金額 | 数字 | ○ | 振込金額（円） |
| I | 顧客コード | 文字列(10桁) | △ | 顧客管理用ID |
| J | 識別表示 | 文字列(1桁) | △ | Y:給与, B:賞与等 |
| K | EDI情報 | 文字列(20文字) | △ | EDI情報（任意） |

#### 1.3 金融機関マスタシート
**シート名**: `金融機関マスタ`

| 列 | 項目名 | データ型 | 必須 | 説明 |
|----|--------|----------|------|------|
| A | 銀行コード | 数字(4桁) | ○ | 金融機関コード（全銀協準拠） |
| B | 銀行名 | 半角カナ(15文字) | ○ | 金融機関名 |
| C | 支店コード | 数字(3桁) | ○ | 支店コード |
| D | 支店名 | 半角カナ(15文字) | ○ | 支店名 |
| E | 更新日 | 日付 | ○ | 最終更新日 |
| F | 状態 | 選択肢 | ○ | 有効/無効 |

**データ制約**:
- 銀行コード+支店コードの組み合わせは重複不可
- 状態が「無効」のレコードは自動補完対象外
- 更新日は自動設定（データ変更時に自動更新）

### 2. GASカスタムメニュー構成

#### 2.1 メニュー構造
```
全銀協システム
├── 振込用CSV取込処理
├── 振込データ作成処理
├── ─────────────────
├── データ検証
├── 金融機関マスタ管理
│   ├── 金融機関データ一括取込
│   ├── 銀行・支店名自動補完
│   └── マスタデータ整備
└── システム設定
    ├── ログ表示
    ├── ログフィルタ表示
    └── システム設定
```

## 機能仕様

### 3. 振込用CSV取込処理機能

#### 3.1 機能概要
- CSVファイルをアップロードして振込データシートに一括取込
- 既存データの上書き/追記選択可能
- データ形式の自動検証とエラーレポート

#### 3.2 対応CSVフォーマット

##### 3.2.1 基本仕様
**ファイル形式**: CSV（Comma-Separated Values）
**文字コード**: UTF-8（BOM付き）またはShift_JIS
**改行コード**: CRLF（Windows形式）、LF（Unix形式）ともに対応
**区切り文字**: カンマ（,）
**囲み文字**: ダブルクォート（"）※値にカンマを含む場合のみ
**ファイルサイズ制限**: 最大10MB
**最大処理件数**: 1,000件/ファイル

##### 3.2.2 CSVヘッダー仕様
CSVファイルの1行目はヘッダー行として以下の項目名を記載してください：
```csv
銀行コード,支店コード,預金種目,口座番号,受取人名,振込金額,顧客コード,識別表示
```

**重要**: ヘッダー行の項目名は完全一致である必要があります。スペースや全角・半角の違いにより取込エラーが発生します。

##### 3.2.3 データ行仕様

| 列番号 | 項目名 | データ型 | 桁数 | 必須 | 形式・制約 | 例 |
|--------|--------|----------|------|------|-----------|-----|
| 1 | 銀行コード | 数値 | 4桁 | ○ | 半角数字、左ゼロ埋め可 | 0001, 1 |
| 2 | 支店コード | 数値 | 3桁 | ○ | 半角数字、左ゼロ埋め可 | 001, 1 |
| 3 | 預金種目 | 数値 | 1桁 | ○ | 1:普通, 2:当座（4:貯蓄は全銀協対象外） | 1 |
| 4 | 口座番号 | 数値 | 1-7桁 | ○ | 半角数字、左ゼロ埋め可 | 1234567, 123456 |
| 5 | 受取人名 | 文字列 | 1-30文字 | ○ | 半角カナ・英数字・記号（カンマ除く） | ﾔﾏﾀﾞﾊﾅｺ |
| 6 | 振込金額 | 数値 | 1-10桁 | ○ | 半角数字、1円以上99億円以下 | 100000 |
| 7 | 顧客コード | 文字列 | 0-10文字 | △ | 半角英数字、空白可 | EMP001, "" |
| 8 | 識別表示 | 文字列 | 0-1文字 | △ | Y:給与, B:賞与, 空白可 | Y, B, "" |

##### 3.2.4 データ制約詳細

**銀行コード・支店コード**:
- CSVでは1桁から4桁（銀行）、1桁から3桁（支店）の数値で入力可能
- システム内部で自動的に左ゼロ埋めして処理
- 金融機関マスタに存在しないコードは警告表示（処理は継続）

**受取人名の文字制限**:
- 使用可能文字: 半角カナ、濁点（゛）、半濁点（゜）、長音（ー）、中点（・）、半角英数字、記号類（カンマ除く）
- 使用不可文字: 全角文字、カンマ（,）
- スペースは半角スペースのみ使用可能
- **注意**: 全銀協フォーマットでは半角英数字も使用可能ですが、金融機関によって制限がある場合があります

**振込金額制限**:
- 最小金額: 1円
- 最大金額: 9,999,999,999円（99億円）
- カンマ区切り（1,000,000）は使用不可
- 負数は使用不可

##### 3.2.5 CSVファイル例

**正常なCSVファイル例**:
```csv
銀行コード,支店コード,預金種目,口座番号,受取人名,振込金額,顧客コード,識別表示
0001,001,1,1234567,ﾔﾏﾀﾞﾊﾅｺ,100000,EMP001,Y
0001,002,1,2345678,ﾀﾅｶﾀﾛｳ,200000,EMP002,Y
0005,123,1,3456789,ｻﾄｳｼﾞﾛｳ,150000,EMP003,B
0009,456,4,4567890,ｽｽﾞｷﾊﾅｺ,80000,,
```

**エラーが発生するCSVファイル例**:
```csv
銀行コード,支店コード,預金種目,口座番号,受取人名,振込金額,顧客コード,識別表示
0001,001,1,1234567,山田花子,100000,EMP001,Y  ← 受取人名が全角（エラー）
0001,002,1,2345678,ﾀﾅｶﾀﾛｳ,-50000,EMP002,Y  ← 振込金額が負数（エラー）
0001,,1,3456789,ｻﾄｳｼﾞﾛｳ,150000,EMP003,B    ← 支店コードが空白（エラー）
ABC,456,1,4567890,ｽｽﾞｷﾊﾅｺ,80000,,X         ← 銀行コードが文字（エラー）
```

##### 3.2.6 取込処理動作

**正常処理フロー**:
1. CSVファイルアップロード
2. ヘッダー行の検証
3. データ行の形式検証
4. 金融機関コードの存在確認（警告のみ）
5. 振込データシートへの取込
6. 銀行名・支店名の自動補完実行
7. 取込結果レポート表示

**エラー処理**:
- **重大エラー**: 取込を中止し、エラー詳細を表示
  - ヘッダー行の項目名不一致
  - 必須項目の未入力
  - データ型不適合
  - 文字数制限超過
  - 使用不可文字の検出
- **警告**: 処理は継続し、警告内容を表示
  - 金融機関マスタに存在しないコード
  - 推奨されない値の使用

##### 3.2.7 ファイル作成時の注意点

**Excel等で作成する場合**:
- 数値項目（銀行コード等）の先頭ゼロが削除される場合があります
- セルの書式を「文字列」に設定することを推奨
- CSV保存時の文字コードに注意（UTF-8推奨）

**テキストエディタで作成する場合**:
- 改行コードはCRLF（Windows）またはLF（Unix）のいずれでも対応
- 文字コードはUTF-8（BOM付き）またはShift_JISを使用
- 値にカンマが含まれる場合はダブルクォートで囲む

**データ準備のベストプラクティス**:
- 受取人名は事前に半角カナに変換
- 金融機関コードは正確性を事前確認
- ファイルサイズ・件数制限の確認
- テスト用の小規模データで事前検証を実施

#### 3.3 処理フロー
1. ファイル選択ダイアログ表示
2. CSVファイル読み込み
3. データ形式検証
4. エラーがある場合はエラーレポート表示
5. 問題なければデータ取込実行
6. 銀行・支店名の自動補完
7. 取込結果レポート表示

### 4. 振込データ作成処理機能

#### 4.1 機能概要
- 入力されたデータから全銀協フォーマットファイルを生成
- ヘッダ、データ、トレーラ、エンドレコードの自動生成
- ファイルダウンロード機能

#### 4.2 処理フロー
1. 振込依頼人情報の検証
2. 振込データの検証
3. 全銀協フォーマット変換
4. ファイル生成
5. ダウンロードリンク提供

#### 4.3 出力ファイル仕様
- **ファイル名**: `FB{YYYYMMDD}_{委託者コード}.{選択した拡張子}`
- **拡張子選択肢**: 
  - `.dat`（標準的な全銀協フォーマット）
  - `.txt`（テキストファイル形式）
  - `.fb`（FB形式：一部金融機関で使用）
- **文字コード**: JIS（全銀協標準）
- **レコード長**: 120バイト固定長
- **レコード構成**: ヘッダ(1) + データ(N) + トレーラ(1) + エンド(1)
- **数値項目の０埋め仕様**:
  - 銀行コード: 4桁左０埋め（例：`1` → `0001`）
  - 支店コード: 3桁左０埋め（例：`5` → `005`）
  - 口座番号: 7桁左０埋め（例：`123456` → `0123456`）
  - 振込金額: 10桁左０埋め（例：`50000` → `0000050000`）
  - 委託者コード: 10桁左０埋め（例：`12345` → `0000012345`）
  - 合計件数: 6桁左０埋め（例：`100` → `000100`）
  - 合計金額: 12桁左０埋め（例：`5000000` → `000005000000`）

##### 4.3.1 銀行名・支店名出力モード

**標準モード（デフォルト）**:
- 全銀協標準仕様に準拠
- データレコードの銀行名フィールド（15バイト）は**半角スペースで埋める**
- データレコードの支店名フィールド（15バイト）は**半角スペースで埋める**
- ほとんどの金融機関で利用可能

**名称出力モード（オプション）**:
- 振込データシートに登録された銀行名・支店名を出力
- 一部の金融機関で独自拡張として利用されている場合に使用
- **注意事項**:
  - 金融機関によってはエラーとなる可能性があるため、事前確認が必要
  - 銀行名・支店名は半角カナ15文字以内の制限あり
  - 文字数超過時は自動的に15文字で切り詰め
  - 金融機関マスタとの整合性は利用者側で確認が必要

#### 4.4 数値コード入力時の０埋め対応

**課題**: スプレッドシートで数値形式の入力（例：`008`）は`8`として表示され、桁数チェックでエラーになる

**解決策**:
1. **シート側の書式設定**: 数値コード項目に０埋め書式を適用
   - 銀行コード: `0000`形式（4桁）
   - 支店コード: `000`形式（3桁）
   - 口座番号: `0000000`形式（7桁）

2. **プログラム側の正規化処理**: 
   - 入力値受取時に自動的に０埋め処理を実行
   - 検証前に`normalizeNumericCode`関数で正規化
   - ユーザーは`8`と入力しても自動的に`008`として処理される

**具体例**:
```
ユーザー入力: 8
シート表示: 008
システム処理: "008"（3桁として正常に認識）
```

### 5. データ検証機能

#### 5.1 振込依頼人情報検証
- 必須項目チェック
- 文字数制限チェック
- 使用可能文字チェック
- 銀行・支店コード妥当性チェック
- 出力ファイル拡張子選択チェック
- 銀行名・支店名出力モード選択チェック

#### 5.2 振込データ検証
- 必須項目チェック
- 数値形式チェック
- 文字数制限チェック
- 使用可能文字チェック
- 振込金額上限チェック
- 重複データチェック
- **銀行名・支店名出力モード「名称出力」選択時の追加検証**:
  - 銀行名・支店名の文字数チェック（15文字以内）
  - 銀行名・支店名の文字種別チェック（半角カナ・英数字のみ）
  - 銀行名・支店名の空白チェック（警告表示）
- **受取人名の姓名間スペースチェック（警告レベル）**:
  - 全銀協仕様では「姓名間のスペースは不要」と記載
  - ただし実務上は許容される場合が多いため、エラーではなく警告として扱う
  - 企業名や外国人名など、スペースが必要な場合を考慮

### 6. 金融機関マスタ管理機能

#### 6.1 金融機関データ一括取込機能

##### 6.1.1 機能概要
- CSVファイルから金融機関マスタデータを一括取込
- 既存データとの重複チェック機能
- データ形式検証とエラーレポート

##### 6.1.2 対応CSVフォーマット
```csv
銀行コード,銀行名,支店コード,支店名,状態
0001,ﾐｽﾞﾎ,001,ﾎﾝﾃﾝ,有効
0001,ﾐｽﾞﾎ,002,ﾕﾗｸﾁｮｳ,有効
```

##### 6.1.3 処理フロー
1. ファイル選択ダイアログ表示
2. CSVファイル読み込み
3. データ形式検証（コード桁数、文字種別等）
4. 重複データチェック
5. エラーがある場合はエラーレポート表示
6. 問題なければデータ取込実行
7. 更新日の自動設定
8. 取込結果レポート表示

#### 6.2 銀行・支店名自動補完機能

##### 6.2.1 機能概要
- 振込データ入力時の銀行コード/支店コード入力による自動補完
- 金融機関マスタシートを参照した名称補完
- リアルタイム入力検証とエラー表示

##### 6.2.2 自動補完動作仕様

**銀行コード入力時の動作**:
1. 振込データシートのA列（銀行コード）に4桁数字入力完了時
2. セルフォーカス移動時（Tab/Enter）に自動実行
3. 金融機関マスタシートから該当銀行名を検索
4. 該当する場合、B列（銀行名）に自動入力

**支店コード入力時の動作**:
1. 振込データシートのC列（支店コード）に3桁数字入力完了時
2. A列の銀行コードと組み合わせて金融機関マスタを検索
3. 該当する場合、D列（支店名）に自動入力

##### 6.2.3 入力検証機能
- **コード形式チェック**: 銀行コード4桁、支店コード3桁の数字形式
- **マスタ存在チェック**: 金融機関マスタシートでの存在確認
- **状態チェック**: マスタデータの状態が「有効」であることの確認

##### 6.2.4 パフォーマンス最適化
- **キャッシュ機能**: 金融機関マスタデータの一時保存
- **非同期処理**: 大量データ処理時の応答性確保
- **処理時間制限**: 検索処理500ms以内での完了

##### 6.2.5 手動一括補完機能

**機能概要**:
振込データシートの既存データに対して、手動で一括して銀行名・支店名を補完する機能です。カスタムメニューから実行可能です。

**補完対象データ**:
- 銀行コードは入力済みだが銀行名が空白の行
- 支店コードは入力済みだが支店名が空白の行
- 銀行名・支店名が入力済みだが、金融機関マスタと不一致の行（修正補完）

**処理フロー**:
1. メニューから「金融機関マスタ管理」→「銀行・支店名自動補完」を選択
2. 振込データシートの全データ行をスキャン（ヘッダー行を除く）
3. 補完対象データの特定と分類
4. 金融機関マスタシートから対応する名称を検索
5. 該当する名称を自動入力
6. 補完結果レポートをダイアログで表示

**補完ロジック**:
- **銀行名補完**: A列の銀行コードを基に、B列が空白または不一致の場合に補完
- **支店名補完**: A列の銀行コード+C列の支店コードを基に、D列が空白または不一致の場合に補完
- **重複回避**: 既に正しい名称が入力済みの場合はスキップ

**補完結果レポート**:
実行後に以下の情報をダイアログで表示
- 検査対象行数
- 銀行名補完件数
- 支店名補完件数
- 補完失敗件数（マスタ未登録等）
- 処理時間

**実行例**:
```
補完前:
行2: [0001][     ][001][     ] ← 銀行名・支店名が空白
行3: [0005][ﾐﾂﾋﾞｼ][002][     ] ← 支店名が空白
行4: [0009][     ][003][ｼﾌﾞﾔ  ] ← 銀行名が空白

補完後:
行2: [0001][ﾐｽﾞﾎ  ][001][ﾎﾝﾃﾝ  ] ← 両方補完完了
行3: [0005][ﾐﾂﾋﾞｼ][002][ﾏﾙﾉｳﾁ] ← 支店名補完完了
行4: [0009][ﾐﾂﾋﾞｼﾕｰ][003][ｼﾌﾞﾔ  ] ← 銀行名補完完了
```

#### 6.3 マスタデータ整備機能

##### 6.3.1 機能概要
- 金融機関マスタの重複データ削除
- 無効データの一括更新
- データ整合性チェック機能

##### 6.3.2 整備項目
- **重複チェック**: 銀行コード+支店コードの重複確認
- **データ形式チェック**: コード桁数、文字種別の確認
- **状態整理**: 無効データの識別と整理
- **更新日整備**: 更新日の一括設定機能

## エラーハンドリング

### 7. エラー種別と対応

#### 7.1 データ形式エラー
- **文字コードエラー**: 使用不可文字の検出
- **文字数エラー**: 規定文字数超過
- **数値形式エラー**: 数値項目に非数値文字
- **必須項目エラー**: 必須項目の未入力

#### 7.2 業務エラー
- **金融機関コードエラー**: 存在しない銀行/支店コード
- **金額エラー**: 上限金額超過、負数
- **重複エラー**: 同一口座への重複振込

#### 7.4 金融機関マスタ関連エラー
- **マスタ重複エラー**: 同一コードの重複登録
  - エラー内容: 「銀行コード[XXXX]+支店コード[XXX]が重複しています」
  - 対応: データ取込時に警告表示、重複データの選択削除

#### 7.3 システムエラー
- **ファイルアクセスエラー**: CSV読み込み失敗
- **メモリエラー**: 大量データ処理時の制限
- **権限エラー**: スプレッドシート操作権限不足

## セキュリティ要件

### 8. セキュリティ対策

#### 8.1 アクセス制御
- スプレッドシートの共有設定による利用者制限
- GASスクリプトの実行権限制御

#### 8.2 データ保護
- 機密データの一時保存制限
- ログ出力時の個人情報マスキング
- 自動バックアップ機能

#### 8.3 監査ログ
- データ作成履歴の記録
- ユーザー操作ログの保持
- エラー発生履歴の追跡

## ログ管理機能

### 8.4 システムログ機能

#### 8.4.1 機能概要
システムの動作状況、エラー発生、ユーザー操作履歴を詳細に記録・管理し、トラブルシューティングやシステム最適化を支援する包括的なログ管理機能です。

#### 8.4.2 ログ分類体系

**ログレベル分類**:
- **INFO**: 正常な処理実行情報
  - 機能実行開始・完了
  - データ処理件数
  - ファイル生成成功
- **WARNING**: 警告事項（処理は継続）
  - データ検証での警告
  - 推奨されない設定値
  - パフォーマンス低下の兆候
- **ERROR**: エラー発生情報
  - データ形式エラー
  - システム処理エラー
  - 機能実行失敗

**機能分類**:
- **CSV取込**: 振込データCSV取込処理関連
- **データ検証**: データ検証機能関連
- **ファイル生成**: 全銀協フォーマットファイル生成関連
- **自動補完**: 銀行・支店名自動補完関連
- **マスタ管理**: 金融機関マスタ管理関連
- **システム**: システム全般・設定関連

#### 8.4.3 ログフィルタリング機能

**フィルタリング条件**:
- **ログレベル別表示**: INFO/WARNING/ERRORの個別・組み合わせ表示
- **機能別表示**: 特定機能のログのみ表示
- **日時範囲指定**: 指定期間内のログ表示
- **キーワード検索**: ログメッセージ内のキーワード検索


**表示オプション**:
- **表示件数制限**: 最新N件のログ表示（デフォルト：50件）
- **詳細表示**: エラーログの詳細情報（スタックトレース含む）
- **要約表示**: 同種のログをまとめて件数表示

#### 8.4.4 パフォーマンスログ

**測定項目**:
- **処理実行時間**: 各機能の実行時間測定
- **データ処理件数**: 処理したレコード数とパフォーマンス関係

**パフォーマンス分析**:
- **処理効率分析**: データ件数と処理時間の関係分析
- **最適化指標**: パフォーマンス改善の効果測定

#### 8.4.5 ユーザー操作履歴

**記録対象操作**:
- **ファイル処理**: CSV取込、ファイル生成の実行
- **設定変更**: システム設定の変更
- **検証実行**: データ検証機能の実行

**詳細情報記録**:
- **エラー詳細**: エラー発生時のスタックトレース
- **実行結果**: 処理成功・失敗と詳細情報

#### 8.4.6 ログ保存・管理仕様

**保存方式**:
- **PropertiesService**: 最新100件の実行ログ（高速アクセス）
- **Logger.log()**: GAS標準ログ（Cloud Console連携）
- **console.log()**: Cloud Loggingとの連携

**保存期間**:
- **実行ログ**: 最新100件（自動循環）
- **詳細ログ**: GAS標準の保持期間（約30日）
- **エラーログ**: 重要度に応じて長期保存

**データ構造**:
```json
{
  "timestamp": "2025-06-21T13:47:00.000Z",
  "level": "INFO|WARNING|ERROR",
  "category": "CSV取込|データ検証|ファイル生成|自動補完|マスタ管理|システム",
  "functionName": "実行された関数名",
  "message": "ログメッセージ",
  "details": {
    "processingTime": 1500,
    "recordCount": 42,
    "errorCode": "E001",
    "stackTrace": "エラー時のスタックトレース"
  },
  "userId": "ユーザーID"
}
```

#### 8.4.7 ログ表示インターフェース

**基本ログ表示（拡張HTML形式）**:
- メニュー「システム設定」→「ログ表示」から実行
- 最新50件のログをHTMLテーブル形式で表示
- ログレベル別の色分け表示（ERROR:赤、WARNING:オレンジ、INFO:緑）
- パフォーマンス情報の詳細表示
- レスポンシブ対応・スクロール可能な表示
- カテゴリ別の視覚的区分

**フィルタリング表示**:
- メニュー「システム設定」→「ログフィルタ表示」から実行
- フィルタ条件選択ダイアログ表示
- 標準表示（HTML形式・色分け・構造化）またはシンプル表示（テキスト形式）の選択可能
- デフォルトで標準表示（HTML形式）が選択される
- 条件に合致するログのみ表示



#### 8.4.8 ログ活用指針

**日常運用での活用**:
- 定期的なログ確認による異常の早期発見
- パフォーマンス低下の兆候モニタリング
- ユーザー操作パターンの分析

**トラブルシューティング**:
- エラー発生時の詳細調査
- 問題の再現条件特定
- 修正効果の検証

**システム最適化**:
- 処理効率改善の効果測定
- ユーザビリティ向上の指標

## 運用要件

### 9. 運用仕様

#### 9.1 性能要件
- **処理可能件数**: 最大1,000件/回
- **レスポンス時間**: 通常処理3秒以内
- **ファイルサイズ制限**: CSV 10MB以内

#### 9.2 バックアップ
- 日次自動バックアップ
- 処理実行前の自動スナップショット
- 履歴データの30日間保持

#### 9.3 メンテナンス
- 金融機関マスタの月次更新
  - 全銀協公開データからの最新情報取得
  - 新設・廃止・統合された金融機関の反映
  - 無効データの状態更新
- システムログの定期クリーンアップ
- 機能改善とバグ修正の継続対応

## 画面設計

### 10. ユーザーインターフェース

#### 10.1 振込依頼人情報登録画面
- 入力フォーム形式
- リアルタイム入力検証
- 出力ファイル拡張子のプルダウン選択
- 保存/クリア機能

#### 10.2 振込データ一覧画面
- 表形式での一覧表示
- 行単位での編集機能
- 一括削除/選択削除機能
- 銀行コード/支店コード入力時のリアルタイム自動補完

#### 10.4 金融機関マスタ管理画面
- 金融機関データの一覧表示（検索・フィルタ機能付き）
- データの一括取込機能（CSVアップロード）
- 重複データの検出と削除機能
- データの有効/無効切り替え機能
- 更新履歴の表示機能

#### 10.3 処理結果画面
- 処理成功/失敗の明確な表示
- エラー詳細の一覧表示
- ファイルダウンロードリンク

## 今後の拡張予定

### 11. 将来機能

#### 11.1 機能拡張
- 口座振替フォーマット対応
- 複数委託者対応
- 承認ワークフロー機能
- API連携機能

#### 11.2 UI/UX改善
- レスポンシブ対応
- 進捗表示機能
- ドラッグ&ドロップ対応
- 一括編集機能

---

## 実装技術詳細

### 12. GAS実装仕様

#### 12.1 自動補完機能の実装
```javascript
// メイン関数：セル編集時のイベントハンドラ
function onEdit(e) {
  if (e.range.getSheet().getName() === '振込データ') {
    handleBankCodeAutoComplete(e);
    handleBranchCodeAutoComplete(e);
  }
}

// 銀行コード自動補完処理
function handleBankCodeAutoComplete(e) {
  const range = e.range;
  const column = range.getColumn();
  const row = range.getRow();
  
  // A列（銀行コード）の入力時
  if (column === 1 && row > 1) {
    const bankCode = range.getValue();
    if (bankCode && bankCode.toString().length === 4) {
      const bankName = getBankNameFromMaster(bankCode);
      if (bankName) {
        // B列に銀行名を自動入力
        range.offset(0, 1).setValue(bankName);
      }
    }
  }
}

// 支店コード自動補完処理
function handleBranchCodeAutoComplete(e) {
  const range = e.range;
  const column = range.getColumn();
  const row = range.getRow();
  
  // C列（支店コード）の入力時
  if (column === 3 && row > 1) {
    const branchCode = range.getValue();
    const bankCode = range.offset(0, -2).getValue();
    
    if (bankCode && branchCode && branchCode.toString().length === 3) {
      const branchName = getBranchNameFromMaster(bankCode, branchCode);
      if (branchName) {
        // D列に支店名を自動入力
        range.offset(0, 1).setValue(branchName);
      }
    }
  }
}
```

#### 12.2 金融機関マスタ検索機能
```javascript
// 金融機関マスタからの検索関数（キャッシュ機能付き）
let masterDataCache = null;
let cacheTimestamp = null;

function getMasterData() {
  const now = new Date().getTime();
  // キャッシュが5分以上古い場合は再読み込み
  if (!masterDataCache || !cacheTimestamp || (now - cacheTimestamp) > 300000) {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('金融機関マスタ');
    const data = sheet.getDataRange().getValues();
    masterDataCache = data.slice(1); // ヘッダー行を除く
    cacheTimestamp = now;
  }
  return masterDataCache;
}

function getBankNameFromMaster(bankCode) {
  const masterData = getMasterData();
  const row = masterData.find(row => row[0] == bankCode && row[5] === '有効');
  return row ? row[1] : null;
}

function getBranchNameFromMaster(bankCode, branchCode) {
  const masterData = getMasterData();
  const row = masterData.find(row => 
    row[0] == bankCode && row[2] == branchCode && row[5] === '有効'
  );
  return row ? row[3] : null;
}
```

#### 12.3 手動一括補完機能の実装
```javascript
// カスタムメニューから実行される一括補完機能
function executeAutoComplete() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('振込データ');
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  let bankNameCompletions = 0;
  let branchNameCompletions = 0;
  let failures = 0;
  const startTime = new Date().getTime();
  
  // ヘッダー行を除いて処理
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const bankCode = row[0];
    const bankName = row[1];
    const branchCode = row[2];
    const branchName = row[3];
    
    // 銀行名補完処理
    if (bankCode && (!bankName || bankName === '')) {
      const correctBankName = getBankNameFromMaster(bankCode);
      if (correctBankName) {
        sheet.getRange(i + 1, 2).setValue(correctBankName);
        bankNameCompletions++;
      } else {
        failures++;
      }
    }
    
    // 支店名補完処理
    if (bankCode && branchCode && (!branchName || branchName === '')) {
      const correctBranchName = getBranchNameFromMaster(bankCode, branchCode);
      if (correctBranchName) {
        sheet.getRange(i + 1, 4).setValue(correctBranchName);
        branchNameCompletions++;
      } else {
        failures++;
      }
    }
  }
  
  const endTime = new Date().getTime();
  const processingTime = endTime - startTime;
  
  // 結果レポート表示
  const reportMessage = `補完処理が完了しました。\n\n` +
    `検査対象行数: ${values.length - 1}行\n` +
    `銀行名補完件数: ${bankNameCompletions}件\n` +
    `支店名補完件数: ${branchNameCompletions}件\n` +
    `補完失敗件数: ${failures}件\n` +
    `処理時間: ${processingTime}ms`;
  
  SpreadsheetApp.getUi().alert('補完結果', reportMessage, SpreadsheetApp.getUi().ButtonSet.OK);
}
```

---

**最終更新日**: 2025年1月16日  
**作成者**: システム開発チーム  
**承認者**: [承認者名]  
**変更履歴**: 
- 2025年1月16日: 金融機関マスタ管理機能・自動補完機能の仕様追加